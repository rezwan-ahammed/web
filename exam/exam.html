<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SecureExam+ - Secure Exam Room</title>
    <!-- The face-api.js script is loaded dynamically by the main script -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- Master Internal Stylesheet (Consistent with other pages) --- */
        :root{
            --bg-color:#F8F9FA;
            --primary-text-color:#121212;
            --secondary-text-color:#595959;
            --accent-color:#3D52F3;
            --accent-color-dark:#2335D8;
            --border-color:rgba(0,0,0,0.1);
            --header-bg:rgba(248,249,250,0.85);
            --shadow-color:rgba(0,0,0,0.06);
            --card-bg:#FFFFFF;
            --error-color:#dc3545;
            --success-color:#28a745;
            --warning-color: #ffc107;
            --light-blue-bg: #EAF0FF;
            --light-gray-text: #6c757d;
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
        }
        *, *:before, *:after { box-sizing: border-box; margin:0; padding:0; }
        html { scroll-behavior: smooth; }
        body {
            font-family:'Plus Jakarta Sans', sans-serif;
            background-color:var(--bg-color); color:var(--primary-text-color); line-height:1.6;
            -webkit-font-smoothing:antialiased;
        }
        body::before {
            content:''; position:fixed; inset:0; z-index:-1;
            background:linear-gradient(320deg,#E4DFFF 0%, #F5FAFF 50%, #DDEEFF 100%);
            animation: gradient-animation 20s ease-in-out infinite; background-size:200% 200%;
        }
        @keyframes gradient-animation{ 0%{ background-position:0% 50%; } 50%{ background-position:100% 50%; } 100%{ background-position:0% 50%; } }
        .container { width:100%; max-width:1200px; margin:0 auto; padding:0 var(--spacing-md); }
        .main-header {
            position:sticky; top:0; z-index:1000; background-color:var(--header-bg);
            backdrop-filter: blur(12px); border-bottom:1px solid var(--border-color);
        }
        .main-header .container { display:flex; justify-content:space-between; align-items:center; height:70px; }
        .logo { font-size:1.6rem; font-weight:800; text-decoration:none; color:var(--primary-text-color); }
        main { padding:var(--spacing-lg) 0; }
        .view { display: none; }
        .view.active { display: block; }
        
        .btn, .primary-btn {
            display:inline-block; background-color:var(--accent-color); color:#FFF; padding:var(--spacing-sm) var(--spacing-lg);
            border:none; border-radius:8px; text-decoration:none; font-weight:600; font-size:1rem; cursor:pointer;
            box-shadow:0 6px 20px rgba(61,82,243,0.25); transition: all .3s ease; text-align: center;
        }
        .btn:hover:not(:disabled), .primary-btn:hover:not(:disabled) {
            background-color:var(--accent-color-dark); transform:translateY(-4px); box-shadow:0 10px 30px rgba(61,82,243,0.35);
        }
        .btn:disabled, .primary-btn:disabled {
            background-color:#aeb8fc; cursor:not-allowed; opacity:0.8; box-shadow: none; transform: none;
        }

        /* --- Loader/Spinner --- */
        #loading-overlay {
            position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1rem; backdrop-filter: blur(5px);
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--accent-color); border-radius: 50%;
            width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Main Card & Header --- */
        .exam-card {
            background-color:var(--card-bg); border-radius:16px; border:1px solid var(--border-color);
            box-shadow:0 12px 48px var(--shadow-color); padding:var(--spacing-xl); margin-top: var(--spacing-lg);
        }
        .exam-header {
            display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color); padding-bottom: var(--spacing-lg);
        }
        .exam-title { font-size: 1.8rem; font-weight: 700; }
        .exam-meta { font-size: 1rem; color: var(--secondary-text-color); }
        .timer {
            background-color: var(--light-blue-bg); color: var(--accent-color-dark); padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 8px; font-size: 1.5rem; font-weight: 700; text-align: center; min-width: 150px;
        }

        /* --- Verification View --- */
        .verification-steps { list-style: none; padding: 0; max-width: 600px; margin: 0 auto; }
        .verification-step {
            display: flex; align-items: center; padding: 15px; border: 1px solid var(--border-color);
            border-radius: 8px; margin-bottom: 15px; font-size: 1.1em;
        }
        .verification-step .status { margin-right: 15px; font-size: 1.5em; }
        .verification-step .description { flex-grow: 1; }
        .verification-step .action button {
            padding: 8px 16px; cursor: pointer; border: none; border-radius: 5px; background-color: var(--accent-color);
            color: white; font-weight: bold;
        }
        .verification-step .action button:disabled { background-color: #ced4da; }
        #verification-video-container { text-align: center; margin-bottom: 1rem; }
        #verification-video { width: 240px; border-radius: 8px; border: 3px solid var(--border-color); transform: scaleX(-1); }
        .button-group { text-align: center; margin-top: 30px; }

        /* --- Exam View Layout --- */
        .exam-layout { display: flex; flex-wrap: wrap; gap: var(--spacing-lg); }
        .exam-content { flex: 3; min-width: 400px; }
        .proctoring-sidebar { flex: 1; min-width: 280px; background: var(--light-blue-bg); padding: var(--spacing-md); border-radius: 12px; border: 1px solid var(--accent-color-dark); }
        #proctoring-video { width: 100%; border-radius: 8px; border: 3px solid var(--border-color); transform: scaleX(-1); }
        .monitoring-status { list-style: none; padding: 0; margin-top: var(--spacing-md); }
        .monitoring-status li { margin-bottom: 12px; font-weight: 500; display: flex; align-items: center; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: var(--success-color); margin-right: 10px; transition: background-color 0.3s; }
        .status-indicator.flagged { background-color: var(--error-color); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--error-color); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        #integrity-score-display { text-align: center; font-size: 1.1em; font-weight: bold; margin: var(--spacing-sm) 0; }
        #integrity-score { font-size: 2.2em; color: var(--accent-color-dark); }

        /* --- Exam Content (MCQ/CQ) --- */
        .progress-bar { width: 100%; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden; margin-bottom: var(--spacing-sm); }
        .progress-bar-inner { height: 100%; width: 0%; background-color: var(--accent-color); transition: width 0.3s ease; }
        .progress-text { color: var(--secondary-text-color); margin-bottom: var(--spacing-lg); }
        .question-text { font-size: 1.5rem; font-weight: 600; margin-bottom: var(--spacing-lg); }
        .options-container { display: grid; grid-template-columns: 1fr; gap: var(--spacing-sm); }
        .option-btn { display: block; width: 100%; padding: var(--spacing-md); font-size: 1rem; text-align: left; background-color: var(--card-bg); color: var(--primary-text-color); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .option-btn:hover { border-color: var(--accent-color); background-color: var(--light-blue-bg); }
        .option-btn.selected { background-color: var(--accent-color); color: white; border-color: var(--accent-color-dark); }
        .mcq-nav { margin-top: var(--spacing-lg); text-align: right; }
        
        .mcq-results-phase .results-summary { font-size: 1.5rem; font-weight: 600; text-align: center; margin-bottom: var(--spacing-md); }
        .mcq-results-phase .results-list li { background-color: #f8f9fa; padding: var(--spacing-sm); border-radius: 8px; margin-bottom: var(--spacing-sm); list-style: none; border-left: 5px solid var(--border-color); }
        .mcq-results-phase .results-list li.correct { border-left-color: var(--success-color); }
        .mcq-results-phase .results-list li.incorrect { border-left-color: var(--error-color); }

        .cq-questions-list { background-color: #f8f9fa; border: 1px solid var(--border-color); padding: var(--spacing-md); border-radius: 8px; margin-bottom: var(--spacing-lg); }
        .cq-questions-list h3 { margin-bottom: var(--spacing-sm); }
        .cq-questions-list ol { padding-left: var(--spacing-md); }
        
        .file-upload-wrapper { border: 2px dashed var(--accent-color); border-radius: 12px; padding: var(--spacing-lg); text-align: center; background-color: var(--light-blue-bg); cursor: pointer; transition: background-color 0.2s ease; }
        .file-upload-wrapper:hover { background-color: #dde6ff; }
        #image-preview { max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px var(--shadow-color); }

        .submission-complete-container { text-align: center; padding: var(--spacing-xl) 0; }
        .submission-complete-container .icon { font-size: 5rem; color: var(--success-color); }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text">Initializing Exam Environment...</p>
    </div>

    <header class="main-header">
        <div class="container">
            <a href="#" class="logo">SecureExam+</a>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- VIEW 1: PRE-EXAM VERIFICATION -->
            <div id="verification-view" class="view active exam-card">
                <h2 style="text-align: center;">Pre-Exam Security Check</h2>
                <p style="text-align: center; color: var(--secondary-text-color);">Please complete the steps below to begin your exam.</p>
                <div id="verification-video-container" class="hidden">
                     <video id="verification-video" autoplay muted playsinline></video>
                </div>
                <ul class="verification-steps">
                    <li id="step-system" class="verification-step">
                        <span class="status">⏳</span>
                        <span class="description">System & Hardware Check (Camera, Mic)</span>
                    </li>
                    <li id="step-face" class="verification-step">
                        <span class="status">⚪</span>
                        <span class="description">Live Facial Verification</span>
                        <span class="action"><button id="verify-face-btn" disabled>Start Verification</button></span>
                    </li>
                </ul>
                <div class="button-group">
                    <button id="begin-exam-btn" class="primary-btn" disabled>Loading AI Models...</button>
                </div>
            </div>

            <!-- VIEW 2: EXAM SESSION -->
            <div id="exam-view" class="view">
                <div class="exam-header">
                    <div>
                        <h1 class="exam-title" id="exam-title-display">Exam In Progress</h1>
                        <p class="exam-meta" id="exam-meta-display"></p>
                    </div>
                    <div class="timer" id="timer-container">
                        <span id="time-display">00:00</span>
                    </div>
                </div>
                <div class="exam-layout">
                    <div class="exam-content">
                        <!-- This is where the different exam phases will be injected -->
                        <div id="exam-phase-container">
                            <!-- MCQ Phase, Results Phase, CQ Phase, etc. go here -->
                        </div>
                    </div>
                    <aside class="proctoring-sidebar">
                        <h3>Live Monitoring</h3>
                        <video id="proctoring-video" autoplay muted playsinline></video>
                        <div id="integrity-score-display">
                            <p>Integrity Score: <span id="integrity-score">100</span>/100</p>
                        </div>
                        <ul class="monitoring-status">
                            <li><span id="status-face" class="status-indicator"></span>Face Presence</li>
                            <li><span id="status-audio" class="status-indicator"></span>Unusual Noise</li>
                            <li><span id="status-browser" class="status-indicator"></span>Browser Focus</li>
                        </ul>
                    </aside>
                </div>
            </div>
            
            <!-- VIEW 3: SUBMISSION COMPLETE -->
            <div id="submission-view" class="view exam-card">
                 <div class="submission-complete-container">
                    <div class="icon">&#10004;</div>
                    <h2>Submission Successful!</h2>
                    <p>Your responses have been recorded. You may now return to your dashboard.</p>
                    <div class="button-group">
                        <a href="student_dashboard.html" class="primary-btn">Back to Dashboard</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <script>
        // --- DOM Elements ---
        const views = { verification: document.getElementById('verification-view'), exam: document.getElementById('exam-view'), submission: document.getElementById('submission-view') };
        const examPhaseContainer = document.getElementById('exam-phase-container');
        const verificationVideo = document.getElementById('verification-video');
        const proctoringVideo = document.getElementById('proctoring-video');
        const verificationVideoContainer = document.getElementById('verification-video-container');
        const beginExamBtn = document.getElementById('begin-exam-btn');
        const steps = { system: document.getElementById('step-system'), face: document.getElementById('step-face') };
        const verifyFaceBtn = document.getElementById('verify-face-btn');
        const integrityScoreEl = document.getElementById('integrity-score');
        const statusIndicators = { face: document.getElementById('status-face'), audio: document.getElementById('status-audio'), browser: document.getElementById('status-browser') };
        const examTitleDisplay = document.getElementById('exam-title-display');
        const examMetaDisplay = document.getElementById('exam-meta-display');
        const timerContainer = document.getElementById('timer-container');
        const timeDisplay = document.getElementById('time-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        // --- Firebase & State Management ---
        let stream, faceMatcher, sessionRef, examData, currentStudent, examId, instId;
        let monitoringIntervals = [];
        let sessionData = { integrityScore: 100, flags: [] };
        let timeRemaining, examTimerInterval, currentMcqIndex = 0, studentMcqAnswers = [];
        
        // --- DEFINITIVE FIX: Using the correct, official URL provided by the user ---
        const FACE_API_MODELS_URI = 'https://justadudewhohacks.github.io/face-api.js/models';
        
        let noiseFlagCounter = 0;

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyAPgoVPBdYnnMHRnKbGJIe87HJ_Py82XUQ",
            authDomain: "mathemate-software.firebaseapp.com",
            databaseURL: "https://mathemate-software-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mathemate-software",
            storageBucket: "mathemate-software.appspot.com",
            messagingSenderId: "780184955321",
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // --- Core Application Flow ---
        function loadFaceApiScript() {
            return new Promise((resolve, reject) => {
                loadingText.textContent = "Loading Face Recognition Library...";
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js';
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load face-api.js script.'));
                document.head.append(script);
            });
        }
        
        async function loadModels() {
            try {
                loadingText.textContent = "Loading Face Detection Model...";
                await faceapi.nets.tinyFaceDetector.loadFromUri(FACE_API_MODELS_URI);
                loadingText.textContent = "Loading Face Landmark Model...";
                await faceapi.nets.faceLandmark68Net.loadFromUri(FACE_API_MODELS_URI);
                loadingText.textContent = "Loading Face Recognition Model...";
                await faceapi.nets.faceRecognitionNet.loadFromUri(FACE_API_MODELS_URI);
                beginExamBtn.textContent = 'Awaiting Verification';
            } catch (error) {
                updateStepStatus(steps.system, 'failed', `AI Models failed to load: ${error.message}. Please refresh.`);
            }
        }

        // --- Initialization Chain ---
        document.addEventListener('DOMContentLoaded', () => {
             loadFaceApiScript()
                .then(() => {
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            currentStudent = user;
                            initializePage();
                        } else {
                            alert("Authentication error. Redirecting to login.");
                            window.location.href = 'index.html';
                        }
                    });
                })
                .catch(error => {
                    console.error(error);
                    loadingText.textContent = error.message;
                });
        });
        
        async function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            examId = urlParams.get('examId');
            instId = urlParams.get('instId');
            if (!examId || !instId) {
                loadingText.textContent = "Error: Invalid Exam Link.";
                return;
            }
            
            try {
                loadingText.textContent = "Fetching exam data...";
                const examSnapshot = await database.ref(`institutions/${instId}/exams/${examId}`).once('value');
                if (!examSnapshot.exists()) throw new Error("Exam data not found.");
                examData = examSnapshot.val();

                await loadModels();
                await runSystemCheck();
                loadingOverlay.classList.add('hidden');
                attachEventListeners();

            } catch(error) {
                loadingText.innerHTML = `Initialization Failed: ${error.message} <br/> Please check the exam link and try again.`;
                console.error("Initialization failed:", error);
            }
        }
        
        // --- PHASE 1: VERIFICATION ---
        async function runSystemCheck() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                verificationVideo.srcObject = stream;
                verificationVideoContainer.classList.remove('hidden');
                updateStepStatus(steps.system, 'success', 'System & Hardware Check');
                verifyFaceBtn.disabled = false;
            } catch (err) {
                updateStepStatus(steps.system, 'failed', 'Camera/Mic access denied. Please grant permissions.');
            }
        }

        async function handleFaceVerification() {
            verifyFaceBtn.disabled = true;
            updateStepStatus(steps.face, 'loading', 'Analyzing face...');
            
            try {
                const studentSnapshot = await database.ref(`students/${currentStudent.uid}`).once('value');
                const studentData = studentSnapshot.val();

                if (!studentData || !studentData.profilePhotoUrl) {
                    updateStepStatus(steps.face, 'failed', 'Profile photo not found.');
                    return;
                }
                
                const referenceImageElement = document.createElement('img');
                referenceImageElement.crossOrigin = 'anonymous';
                referenceImageElement.src = studentData.profilePhotoUrl;
                
                await new Promise((resolve, reject) => {
                    referenceImageElement.onload = resolve;
                    referenceImageElement.onerror = () => reject(new Error('Could not load profile photo.'));
                });

                const referenceResult = await faceapi.detectSingleFace(referenceImageElement).withFaceLandmarks().withFaceDescriptor();

                if (!referenceResult) {
                     updateStepStatus(steps.face, 'failed', 'Could not detect a face in your registered profile photo.');
                     verifyFaceBtn.disabled = false;
                     return;
                }
                
                faceMatcher = new faceapi.FaceMatcher(referenceResult);

                const liveResult = await faceapi.detectSingleFace(verificationVideo, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if (liveResult) {
                    const bestMatch = faceMatcher.findBestMatch(liveResult.descriptor);
                    if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.5) {
                        updateStepStatus(steps.face, 'success', 'Face verification successful.');
                        beginExamBtn.disabled = false;
                        beginExamBtn.textContent = 'Begin Exam';
                    } else {
                         updateStepStatus(steps.face, 'failed', `Face does not match (Confidence: ${((1-bestMatch.distance)*100).toFixed(1)}%). Try better lighting.`);
                         verifyFaceBtn.disabled = false;
                    }
                } else {
                     updateStepStatus(steps.face, 'failed', 'No face detected in live video.');
                     verifyFaceBtn.disabled = false;
                }
            } catch(e) {
                 updateStepStatus(steps.face, 'failed', 'An error occurred during verification.');
                 console.error(e);
                 verifyFaceBtn.disabled = false;
            }
        }
        
        // --- PHASE 2: EXAM SESSION & MONITORING ---
        async function beginExam() {
            sessionRef = database.ref(`institutions/${instId}/sessions/${examId}/${currentStudent.uid}`);
            sessionData.startTime = new Date().toISOString();
            await sessionRef.set(sessionData);

            switchView('exam');
            proctoringVideo.srcObject = stream;
            examTitleDisplay.textContent = examData.title;
            examMetaDisplay.textContent = `Duration: ${examData.duration} minutes`;
            timeRemaining = examData.duration * 60;
            
            startTimer();
            startMonitoring();
            startMcqPhase();
        }

        function startMonitoring() {
            startVisualMonitoring();
            startAudioMonitoring();
            startBrowserMonitoring();
        }

        function startVisualMonitoring() {
            const interval = setInterval(async () => {
                if (!proctoringVideo) { clearInterval(interval); return; }
                const detections = await faceapi.detectAllFaces(proctoringVideo, new faceapi.TinyFaceDetectorOptions());
                if (detections.length === 0) {
                    logFlag('face', 'No face detected.', 2);
                } else if (detections.length > 1) {
                    logFlag('face', 'Multiple faces detected.', 10);
                } else {
                    statusIndicators.face.classList.remove('flagged');
                }
            }, 5000);
            monitoringIntervals.push(interval);
        }

        function startAudioMonitoring() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 512;
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                const interval = setInterval(() => {
                    analyser.getByteFrequencyData(dataArray);
                    let average = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                    
                    if (average > 30) {
                        noiseFlagCounter++;
                    } else {
                        noiseFlagCounter = 0;
                        statusIndicators.audio.classList.remove('flagged');
                    }

                    if (noiseFlagCounter >= 3) {
                        logFlag('audio', 'Sustained unusual noise detected.', 3);
                    }

                }, 1000);
                monitoringIntervals.push(interval);
            } catch(e) {
                console.warn("Could not start audio monitoring:", e.message);
                statusIndicators.audio.parentElement.style.color = '#aaa';
                statusIndicators.audio.style.backgroundColor = '#aaa';
            }
        }

        function startBrowserMonitoring() {
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('paste', handlePaste);
        }
        function handleVisibilityChange() { if (document.hidden) logFlag('browser', 'User switched tabs.', 5); }
        function handlePaste(e) {
            logFlag('browser', 'Paste event detected.', 1);
            alert("Pasting is disabled during the exam.");
            e.preventDefault(); 
        }

        // --- EXAM LOGIC (MCQ, CQ, etc.) ---
        function startMcqPhase() {
            const mcqs = examData.questions ? examData.questions.filter(q => q.type === 'mcq') : [];
            if (mcqs.length === 0) {
                startCqPhase();
                return;
            }
            studentMcqAnswers = new Array(mcqs.length).fill(null);
            displayMcq(currentMcqIndex);
        }
        
        function displayMcq(index) {
             const mcqs = examData.questions.filter(q => q.type === 'mcq');
             const mcq = mcqs[index];

             let optionsHtml = mcq.options.map(optionText => 
                `<button class="option-btn" data-answer="${optionText}">${optionText}</button>`
             ).join('');

             examPhaseContainer.innerHTML = `
                <div id="mcq-phase">
                    <div class="progress-bar"><div class="progress-bar-inner" style="width:${((index + 1) / mcqs.length) * 100}%"></div></div>
                    <p class="progress-text">Question ${index + 1} of ${mcqs.length}</p>
                    <p class="question-text">${mcq.question}</p>
                    <div class="options-container" id="options-container">${optionsHtml}</div>
                    <div class="mcq-nav"><button id="next-mcq-btn" class="primary-btn">Next</button></div>
                </div>
             `;
        }

        function selectOption(selectedButton) {
            document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
            selectedButton.classList.add('selected');
            studentMcqAnswers[currentMcqIndex] = selectedButton.dataset.answer;
            sessionRef.child(`mcqAnswers/${currentMcqIndex}`).set(selectedButton.dataset.answer);
        }

        function handleNextMcq() {
            if (studentMcqAnswers[currentMcqIndex] === null) {
                alert("Please select an answer.");
                return;
            }
            currentMcqIndex++;
            const mcqs = examData.questions.filter(q => q.type === 'mcq');
            if (currentMcqIndex < mcqs.length) {
                displayMcq(currentMcqIndex);
            } else {
                showMcqResults();
            }
        }
        
        function showMcqResults() {
             let correctCount = 0;
             const mcqs = examData.questions.filter(q => q.type === 'mcq');
             let resultsHtml = studentMcqAnswers.map((answer, index) => {
                const isCorrect = answer === mcqs[index].answer;
                if (isCorrect) correctCount++;
                return `
                    <li class="${isCorrect ? 'correct' : 'incorrect'}">
                        <p><strong>Q${index + 1}:</strong> ${mcqs[index].question}</p>
                        <p>Your Answer: <strong>${answer}</strong></p>
                        ${!isCorrect ? `<p>Correct Answer: <strong>${mcqs[index].answer}</strong></p>` : ''}
                    </li>
                `;
             }).join('');

             sessionRef.child('mcqScore').set(correctCount);
             
             const hasCqs = examData.questions && examData.questions.some(q => q.type === 'cq');
             examPhaseContainer.innerHTML = `
                <div id="mcq-results-phase">
                    <h2 class="text-center">MCQ Results</h2>
                    <p class="results-summary">You scored ${correctCount} out of ${mcqs.length} on the MCQs.</p>
                    <ul class="results-list">${resultsHtml}</ul>
                    <div class="button-group">
                        <button id="continue-cq-btn" class="primary-btn">${hasCqs ? 'Continue to Written Questions' : 'Finish & Submit Exam'}</button>
                    </div>
                </div>
             `;
        }

        function startCqPhase() {
            const cqs = examData.questions ? examData.questions.filter(q => q.type === 'cq') : [];
            if (cqs.length === 0) {
                submitExam();
                return;
            }
            sessionRef.child('status').set('mcq_completed');
            
            const cqListHtml = `<ol>${cqs.map(q => `<li>${q.question}</li>`).join('')}</ol>`;
            examPhaseContainer.innerHTML = `
                <div id="cq-phase">
                    <h2>Conventional Questions (CQ)</h2>
                    <p style="color: var(--secondary-text-color);">Write answers on paper, then take a clear photo and upload it.</p>
                    <div class="cq-questions-list">${cqListHtml}</div>
                    <label for="cq-file-input" class="file-upload-wrapper">
                         <p>Click to upload your answer script.</p>
                    </label>
                    <input type="file" id="cq-file-input" class="hidden" accept="image/jpeg, image/png">
                    <div class="text-center mt-md hidden" id="image-preview-container"><img id="image-preview" src="#"/></div>
                    <div class="button-group">
                        <button id="submit-exam-btn" class="primary-btn" disabled>Submit Final Answers</button>
                    </div>
                </div>
            `;
        }

        async function uploadCqAndSubmit() {
            const file = document.getElementById('cq-file-input').files[0];
            if (!file) return;
            
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = "Uploading your answer script...";
            
            const filePath = `cq_submissions/${examId}/${currentStudent.uid}.jpg`;
            try {
                const uploadTask = await storage.ref(filePath).put(file);
                const downloadURL = await uploadTask.ref.getDownloadURL();
                await sessionRef.child('cqSubmissionUrl').set(downloadURL);
                await submitExam();
            } catch (error) {
                loadingOverlay.classList.add('hidden');
                alert(`Upload failed: ${error.message}`);
            }
        }

        // --- PHASE 3: SUBMISSION ---
        async function submitExam() {
            stopMonitoring();
            sessionData.endTime = new Date().toISOString();
            await sessionRef.update({ 
                integrityScore: sessionData.integrityScore, 
                flags: sessionData.flags, 
                endTime: sessionData.endTime, 
                status: 'SUBMITTED' 
            });
            switchView('submission');
        }

        function stopMonitoring() {
            monitoringIntervals.forEach(clearInterval);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.removeEventListener('paste', handlePaste);
            if (stream) stream.getTracks().forEach(track => track.stop());
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        function startTimer() {
            examTimerInterval = setInterval(() => {
                timeRemaining--;
                if (timeRemaining <= 0) {
                    clearInterval(examTimerInterval);
                    alert("Time's up! Your exam will be submitted automatically.");
                    submitExam();
                }
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }
        
        function logFlag(type, description, severity) {
            if (!statusIndicators[type]) return;
            statusIndicators[type].classList.add('flagged');
            sessionData.integrityScore -= severity;
            if (sessionData.integrityScore < 0) sessionData.integrityScore = 0;
            integrityScoreEl.textContent = sessionData.integrityScore;
            
            const flag = { timestamp: new Date().toISOString(), type, description, severity };
            sessionData.flags.push(flag);
            if (sessionRef) sessionRef.child('flags').push(flag);
        }

        function switchView(viewName) {
            Object.values(views).forEach(v => v.classList.remove('active'));
            views[viewName].classList.add('active');
        }

        function updateStepStatus(stepElement, status, text) {
            const statusIcon = stepElement.querySelector('.status');
            const description = stepElement.querySelector('.description');
            const button = stepElement.querySelector('button');
            if (button) button.disabled = true;

            switch (status) {
                case 'success': statusIcon.textContent = '✅'; break;
                case 'failed': statusIcon.textContent = '❌'; break;
                case 'loading': statusIcon.textContent = '⏳'; break;
            }
            description.textContent = text;
        }

        function attachEventListeners() {
            verifyFaceBtn.addEventListener('click', handleFaceVerification);
            beginExamBtn.addEventListener('click', beginExam);
            
            examPhaseContainer.addEventListener('click', (e) => {
                if(e.target.id === 'next-mcq-btn') handleNextMcq();
                if(e.target.id === 'continue-cq-btn') startCqPhase();
                if(e.target.id === 'submit-exam-btn') uploadCqAndSubmit();
                if(e.target.classList.contains('option-btn')) selectOption(e.target);
            });

            examPhaseContainer.addEventListener('change', (e) => {
                 if(e.target.id === 'cq-file-input') {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('image-preview').src = URL.createObjectURL(file);
                        document.getElementById('image-preview-container').classList.remove('hidden');
                        document.getElementById('submit-exam-btn').disabled = false;
                    }
                 }
            });
        }
    </script>
</body>
</html>
