<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Professional Portfolio</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background:#f1f5f9;
}
.app-shell {
  max-width:480px;
  margin:0 auto;
  background:#fff;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
.chat-bubble {
  max-width:80%;
  padding:12px 16px;
  border-radius:18px;
  font-size:14px;
}
.b-visitor { background:#2563eb; color:#fff; margin-left:auto; }
.b-admin { background:#e5e7eb; color:#000; margin-right:auto; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const {useState,useEffect,useRef} = React;

/* ---------- CONFIG ---------- */
const CONFIG = {
  apiKey: "AIzaSyAH5NrTOu9uT9_WMBlBhJS4Dqd-qkPEYs8",
  authDomain: "general-57884.firebaseapp.com",
  databaseURL: "https://general-57884-default-rtdb.firebaseio.com",
  projectId: "general-57884",
  appId: "1:5002724584:web:80fde1ae04c6276eb9b55d"
};
const DATA_PATH = "artifacts/main-portfolio/public/data";

/* ---------- APP ---------- */
function App(){
  const [visitor,setVisitor]=useState(null);
  const [gate,setGate]=useState(false);
  const [chat,setChat]=useState(false);
  const rtdb=useRef(null);

  useEffect(()=>{
    if(!firebase.apps.length) firebase.initializeApp(CONFIG);
    rtdb.current=firebase.database();
    firebase.auth().signInAnonymously();
  },[]);

  return(
    <div className="app-shell">

      <header className="p-4 border-b flex justify-between items-center">
        <h1 className="font-bold text-lg">portfolio.</h1>
        {visitor && <img src={visitor.selfieData} className="w-9 h-9 rounded-full object-cover"/>}
      </header>

      <main className="flex-1 overflow-y-auto p-6 space-y-6">
        <h2 className="text-2xl font-bold">Rejwan Rejvi</h2>
        <p className="text-slate-600">
          Frontend Engineer · UI Systems · React
        </p>
        <button
          onClick={()=>visitor?setChat(true):setGate(true)}
          className="w-full bg-black text-white py-3 rounded-xl font-semibold">
          Connect
        </button>
      </main>

      {gate && (
        <Gatekeeper
          rtdb={rtdb.current}
          onClose={()=>setGate(false)}
          onSuccess={(v)=>{setVisitor(v);setGate(false);setChat(true);}}
        />
      )}

      {chat && visitor && (
        <Messenger
          visitor={visitor}
          rtdb={rtdb.current}
          onClose={()=>setChat(false)}
        />
      )}

    </div>
  );
}

/* ---------- GATEKEEPER ---------- */
function Gatekeeper({onClose,onSuccess,rtdb}){
  const [step,setStep]=useState(1);
  const [name,setName]=useState("");
  const [locked,setLocked]=useState(false);
  const videoRef=useRef(null);
  let streamRef=useRef(null);

  useEffect(()=>{
    if(step===3){
      navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}})
        .then(s=>{
          streamRef.current=s;
          videoRef.current.srcObject=s;
        });
    }
    return ()=>{
      if(streamRef.current){
        streamRef.current.getTracks().forEach(t=>t.stop());
        streamRef.current=null;
      }
    };
  },[step]);

  const capture=async()=>{
    if(locked) return;
    setLocked(true);
    const canvas=document.createElement("canvas");
    canvas.width=400;canvas.height=400;
    canvas.getContext("2d").drawImage(videoRef.current,0,0,400,400);
    const selfie=canvas.toDataURL("image/jpeg",0.7);
    const data={name,selfieData:selfie,ts:Date.now()};
    await rtdb.ref(`${DATA_PATH}/verifications/${data.ts}`).set(data);
    onSuccess(data);
  };

  return(
    <div className="fixed inset-0 bg-black/60 flex items-end p-4">
      <div className="bg-white w-full rounded-2xl p-6">

        {step===1 && (
          <>
            <h2 className="font-bold text-xl mb-2">Quick Verification</h2>
            <p className="text-sm text-slate-500 mb-6">
              Helps prevent spam and keeps conversations meaningful.
            </p>
            <input
              placeholder="Your name"
              className="w-full border rounded-xl px-4 py-3 mb-4"
              onChange={e=>setName(e.target.value)}
            />
            <button
              disabled={!name}
              onClick={()=>setStep(3)}
              className="w-full bg-black text-white py-3 rounded-xl">
              Continue
            </button>
          </>
        )}

        {step===3 && (
          <>
            <h2 className="font-bold text-xl mb-4">Take a selfie</h2>
            <video ref={videoRef} autoPlay playsInline className="w-full rounded-xl mb-4"/>
            <button
              onClick={capture}
              disabled={locked}
              className="w-full bg-blue-600 text-white py-3 rounded-xl">
              {locked?"Processing...":"Verify"}
            </button>
          </>
        )}

        <button onClick={onClose} className="mt-4 text-sm text-slate-400">
          Cancel
        </button>

      </div>
    </div>
  );
}

/* ---------- MESSENGER ---------- */
function Messenger({visitor,rtdb,onClose}){
  const [msgs,setMsgs]=useState([]);
  const [input,setInput]=useState("");
  const [locked,setLocked]=useState(false);
  const scrollRef=useRef();

  useEffect(()=>{
    const ref=rtdb.ref(`${DATA_PATH}/messages/${visitor.ts}`);
    ref.on("value",s=>{
      const list=s.val()
        ? Object.values(s.val()).sort((a,b)=>a.ts-b.ts)
        : [];
      setMsgs(list);
    });
    return()=>ref.off();
  },[]);

  useEffect(()=>{
    if(msgs.at(-1)?.sender==="visitor"){
      scrollRef.current?.scrollIntoView({behavior:"smooth"});
    }
  },[msgs]);

  const send=async()=>{
    if(!input.trim()||locked) return;
    setLocked(true);
    await rtdb.ref(`${DATA_PATH}/messages/${visitor.ts}`)
      .push({text:input,sender:"visitor",ts:Date.now()});
    setInput("");
    setTimeout(()=>setLocked(false),500);
  };

  return(
    <div className="fixed inset-0 bg-white flex flex-col">

      <header className="p-4 border-b flex justify-between items-center">
        <p className="font-semibold">Conversation</p>
        <button onClick={onClose}>Close</button>
      </header>

      <div className="flex-1 p-4 overflow-y-auto space-y-3 bg-slate-50">
        {msgs.map((m,i)=>(
          <div key={i} className={`chat-bubble ${m.sender==="visitor"?"b-visitor":"b-admin"}`}>
            {m.text}
          </div>
        ))}
        <div ref={scrollRef}/>
      </div>

      <div className="p-4 border-t flex gap-2">
        <input
          value={input}
          onChange={e=>setInput(e.target.value)}
          className="flex-1 bg-slate-100 rounded-full px-4 py-2"
          placeholder="Message…"
        />
        <button onClick={send} className="text-blue-600 font-semibold">
          Send
        </button>
      </div>

    </div>
  );
}

/* ---------- RENDER ---------- */
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
