<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Mahammud Hasan Mahadi</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Firebase SDKs (Auth is not needed) -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-storage-compat.js" defer></script>
    <style>
        :root {
            --admin-bg: #F4F7FC; --admin-text: #1a1a1a; --admin-subtle-text: #6c757d;
            --admin-accent: #3D52F3; --admin-accent-dark: #2335D8; --admin-border: #dee2e6;
            --admin-white: #ffffff; --admin-danger: #e74c3c; --admin-danger-dark: #c0392b;
            --admin-success: #22c55e;
        }
        *, *:before, *:after { box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--admin-bg); color: var(--admin-text); margin: 0; padding: 2rem; }
        .hidden { display: none !important; }
        .btn { padding: 0.9rem; font-size: 1rem; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; width: 100%; }
        .btn-primary { background-color: var(--admin-accent); color: var(--admin-white); }
        .btn-primary:hover { background-color: var(--admin-accent-dark); }
        .btn-danger { background-color: var(--admin-danger); color: var(--admin-white); font-size: 0.8rem; padding: 0.4rem 0.8rem; width: auto; }
        .btn-danger:hover { background-color: var(--admin-danger-dark); }
        .btn-secondary { background-color: #6c757d; color: var(--admin-white); font-size: 0.8rem; padding: 0.4rem 0.8rem; width: auto; }
        
        #admin-dashboard-view { width: 100%; max-width: 1200px; margin: auto; padding: 2rem; background-color: var(--admin-white); border-radius: 8px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); }
        .admin-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--admin-border); padding-bottom: 1rem; margin-bottom: 2rem; }
        .admin-header h1 { margin: 0; }
        .warning-text { color: var(--admin-danger); font-weight: 700; font-size: 1rem; }
        .dashboard-content { display: grid; grid-template-columns: 1fr 2fr; gap: 3rem; }
        .form-section h2, .list-section h2 { margin-top: 0; margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.8rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group textarea { width: 100%; padding: 0.8rem; font-size: 1rem; border-radius: 6px; border: 1px solid var(--admin-border); }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .upload-section { border: 2px dashed var(--admin-border); padding: 1.5rem; border-radius: 8px; text-align: center; margin-bottom: 1.5rem; }
        .upload-section p { margin: 0 0 1rem 0; color: var(--admin-subtle-text); }
        #file-upload { display: none; }
        #file-upload-label { background-color: var(--admin-accent); color: var(--admin-white); padding: 0.7rem 1.5rem; border-radius: 6px; cursor: pointer; display: inline-block; }
        #upload-progress { width: 100%; margin: 1rem 0; }
        #image-preview-list { list-style: none; padding: 0; margin-top: 1rem; }
        #image-preview-list li { display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; padding: 0.5rem; border-radius: 5px; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--admin-success); word-break: break-all; }
        #project-list ul { list-style: none; padding: 0; }
        #project-list li { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-radius: 6px; }
        #project-list li:nth-child(odd) { background-color: #f8f9fa; }
        @media (max-width: 900px) { .dashboard-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="admin-dashboard-view">
        <header class="admin-header">
            <h1>Portfolio Dashboard</h1>
            <span class="warning-text">⚠️ PUBLIC ACCESS MODE</span>
        </header>
        <div class="dashboard-content">
            <section class="form-section">
                <h2 id="form-title">Add New Project</h2>
                <div class="upload-section">
                    <p>Upload project images here first.</p>
                    <input type="file" id="file-upload" multiple accept="image/*">
                    <label for="file-upload" id="file-upload-label">Choose Files</label>
                    <progress id="upload-progress" value="0" max="100" class="hidden"></progress>
                    <ul id="image-preview-list"></ul>
                </div>
                <form id="project-form">
                    <input type="hidden" id="project-id">
                    <div class="form-group"><label for="project-title">Title</label><input type="text" id="project-title" required></div>
                    <div class="form-group"><label for="project-category">Category</label><input type="text" id="project-category" required></div>
                    <div class="form-group"><label for="project-description">Description</label><textarea id="project-description" required></textarea></div>
                    <button type="submit" class="btn btn-primary" id="submit-btn">Add Project</button>
                    <button type="button" class="btn btn-secondary hidden" id="cancel-btn">Cancel Edit</button>
                </form>
            </section>
            <section class="list-section">
                <h2>Existing Projects</h2>
                <div id="project-list"><ul><!-- JS Loads Content Here --></ul></div>
            </section>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyAPgoVPBdYnnMHRnKbGJIe87HJ_Py82XUQ",
            authDomain: "mathemate-software.firebaseapp.com",
            databaseURL: "https://mathemate-software-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mathemate-software",
            storageBucket: "mathemate-software.appspot.com",
            messagingSenderId: "780184955321",
            appId: "YOUR_WEB_APP_ID" // Optional, but recommended
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        const projectsRef = database.ref('projects');

        const projectForm = document.getElementById('project-form');
        const projectList = document.querySelector('#project-list ul');
        const fileUpload = document.getElementById('file-upload');
        const progressEl = document.getElementById('upload-progress');
        const imagePreviewList = document.getElementById('image-preview-list');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const projectIdField = document.getElementById('project-id');
        let uploadedImageUrls = [];

        fileUpload.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length === 0) return;
            progressEl.classList.remove('hidden');
            let uploadsCompleted = 0;
            Array.from(files).forEach(file => {
                const fileName = `${Date.now()}-${file.name}`;
                const uploadTask = storage.ref(`projects/${fileName}`).put(file);
                uploadTask.on('state_changed',
                    (snapshot) => {
                        progressEl.value = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    },
                    (error) => console.error("Upload Error:", error),
                    () => {
                        uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
                            uploadedImageUrls.push(downloadURL);
                            const li = document.createElement('li');
                            li.textContent = `✅ ${file.name}`;
                            imagePreviewList.appendChild(li);
                            uploadsCompleted++;
                            if (uploadsCompleted === files.length) {
                                progressEl.classList.add('hidden');
                            }
                        });
                    }
                );
            });
        });

        const fetchProjects = () => {
            projectsRef.on('value', snapshot => {
                projectList.innerHTML = '';
                const projects = snapshot.val();
                if (projects) {
                    Object.entries(projects).forEach(([key, project]) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<div>${project.title}</div><div><button class="btn btn-secondary edit-btn" data-id="${key}" style="width:auto;margin-right:0.5rem">Edit</button><button class="btn btn-danger delete-btn" data-id="${key}">Delete</button></div>`;
                        projectList.appendChild(li);
                    });
                }
            });
        };

        projectForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (uploadedImageUrls.length === 0 && !projectIdField.value) {
                alert("Please upload at least one image.");
                return;
            }
            const project = {
                title: projectForm['project-title'].value,
                category: projectForm['project-category'].value,
                description: projectForm['project-description'].value,
                imageUrls: uploadedImageUrls,
            };
            const projectId = projectIdField.value;
            if (projectId) {
                projectsRef.child(projectId).child('imageUrls').get().then(snapshot => {
                    const existingUrls = snapshot.val() || [];
                    project.imageUrls = [...existingUrls, ...uploadedImageUrls];
                    projectsRef.child(projectId).update(project).then(resetForm);
                });
            } else {
                projectsRef.push(project).then(resetForm);
            }
        });

        const resetForm = () => {
            projectForm.reset();
            imagePreviewList.innerHTML = '';
            uploadedImageUrls = [];
            projectIdField.value = '';
            formTitle.textContent = 'Add New Project';
            submitBtn.textContent = 'Add Project';
            cancelBtn.classList.add('hidden');
        };

        projectList.addEventListener('click', e => {
            const projectId = e.target.dataset.id;
            if (e.target.classList.contains('delete-btn')) {
                if (confirm('Are you sure? This does not delete the stored images.')) {
                    projectsRef.child(projectId).remove();
                }
            } else if (e.target.classList.contains('edit-btn')) {
                projectsRef.child(projectId).once('value', snapshot => {
                    resetForm();
                    const project = snapshot.val();
                    projectForm['project-title'].value = project.title || '';
                    projectForm['project-category'].value = project.category || '';
                    projectForm['project-description'].value = project.description || '';
                    if (project.imageUrls) {
                        project.imageUrls.forEach(url => {
                            const li = document.createElement('li');
                            li.innerHTML = `<span>✔️ ${url.substring(0, 40)}... (existing)</span>`;
                            imagePreviewList.appendChild(li);
                        });
                    }
                    projectIdField.value = projectId;
                    formTitle.textContent = 'Edit Project (Add New Images)';
                    submitBtn.textContent = 'Save Changes';
                    cancelBtn.classList.remove('hidden');
                    window.scrollTo(0, 0);
                });
            }
        });

        cancelBtn.addEventListener('click', resetForm);
        fetchProjects(); // Initial call to load projects
    </script>
</body>
</html>
