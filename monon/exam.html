<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Exam Session - SecureExam+</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent-color: #3D52F3; --accent-color-dark: #2335D8; --border-color: rgba(0, 0, 0, 0.1); --shadow-color: rgba(0, 0, 0, 0.04); --success-color: #28a745; --danger-color: #dc3545; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8F9FA; margin: 0; color: #121212; }
        body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; background: linear-gradient(320deg, #E4DFFF 0%, #F5FAFF 100%); animation: gradient-animation 20s ease-in-out infinite; background-size: 200% 200%; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .container { max-width: 1200px; margin: auto; padding: 2rem; }
        .header { background: #fff; padding: 0 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; height: 70px; position: sticky; top: 0; z-index: 1000; }
        .header h1 { font-size: 1.5rem; }
        .header .header-info { text-align: right; } .header .header-info h3, .header .header-info p { margin: 0; line-height: 1.2; }
        .content-card { background: #fff; border-radius: 12px; padding: clamp(1.5rem, 5vw, 3rem); box-shadow: 0 10px 40px var(--shadow-color); }
        h2 { text-align: center; margin-bottom: 1rem; }
        .content-card > p { max-width: 600px; margin: 0 auto 3rem; text-align: center; color: #595959; }
        .view { display: none; } .view.active { display: block; }
        .exam-layout { display: grid; grid-template-columns: 1fr 320px; gap: 2.5rem; }
        .proctoring-sidebar { background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); }
        #video { width: 100%; border-radius: 8px; transform: scaleX(-1); border: 1px solid var(--border-color); }
        .monitoring-status li { display: flex; align-items: center; margin-bottom: 1rem; font-weight: 500; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; background-color: var(--success-color); margin-right: 1rem; flex-shrink: 0; transition: background-color .3s; }
        .status-indicator.flagged { background-color: var(--danger-color); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        #integrity-score { font-size: 2.5em; font-weight: 800; color: var(--accent-color); }
        .exam-paper { border: 1px solid var(--border-color); padding: 2rem; border-radius: 12px; height: 50vh; overflow-y: auto; background: #fff; }
        .question-block { margin-bottom: 2rem; border-bottom: 1px solid #eee; padding-bottom: 1rem; }
        .mcq-option { margin-bottom: 0.5rem; }
        .cta-button { display: inline-block; background-color: var(--accent-color); color: #FFF; padding: 1rem 2.5rem; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; transition: all .3s ease; }
        .cta-button:disabled { background-color: #ccc; cursor: not-allowed; }
        .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); color: white; display: none; justify-content: center; align-items: center; text-align: center; z-index: 9999; }
        .fullscreen-overlay h2 { font-size: 3em; } .fullscreen-overlay p { font-size: 1.5em; }
    </style>
</head>
<body>
    <div class="header"><h1>Secure Session</h1><div id="header-info" class="header-info" style="display: none;"><h3 id="exam-title-header"></h3><p id="exam-timer"></p></div></div>
    <div class="container">
        <div class="content-card">
            <div id="loader-view" class="view active" style="text-align:center;"><h2>Initializing Secure Session...</h2></div>
            <div id="error-view" class="view" style="text-align:center; color: var(--danger-color);"><h2>An Error Occurred</h2><p id="error-message"></p></div>
            <div id="pre-exam-view" class="view" style="text-align:center;">
                <h2>Pre-Exam Security Check</h2><p>Please follow the instructions to begin.</p>
                <video id="pre-exam-video" autoplay muted playsinline style="width:300px; border-radius:8px; transform: scaleX(-1);"></video>
                <p id="face-match-status" style="font-weight:bold; font-size: 1.2em;">Verifying Identity...</p>
                <ul style="text-align:left; max-width:500px; margin: 2rem auto;"><li>Ensure your face is clearly visible.</li><li>You must remain in the tab for the entire exam.</li><li>No other people, phones, or materials are allowed.</li></ul>
                <button id="start-exam-btn" class="cta-button" disabled>Start Exam</button>
            </div>
            <div id="exam-phase-view" class="view"></div>
            <div id="mcq-result-view" class="view" style="text-align:center;">
                <h2>MCQ Section Complete</h2><p id="mcq-score-display" style="font-size: 1.5em; font-weight: bold;"></p>
                <p>You will now proceed to the written answer (CQ) section.</p>
                <button id="proceed-to-cq-btn" class="cta-button">Continue to Written Section</button>
            </div>
            <div id="upload-view" class="view"></div>
            <div id="submission-view" class="view" style="text-align:center;"><h2>Exam Submitted Successfully</h2></div>
        </div>
    </div>
    <div id="focus-lost-overlay" class="fullscreen-overlay"><div><h2>Warning: Focus Lost</h2><p>Return to the exam tab immediately!</p><h2 id="focus-timer">15</h2></div></div>

    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAPgoVPBdYnnMHRnKbGJIe87HJ_Py82XUQ", authDomain: "mathemate-software.firebaseapp.com", databaseURL: "https://mathemate-software-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "mathemate-software", storageBucket: "mathemate-software.appspot.com", messagingSenderId: "780184955321", appId: "YOUR_WEB_APP_ID" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        
        let examData, sessionState, studentProfile, examId, instId, currentUser, sessionRef, stream;
        let mainTimerInterval, focusLossInterval;
        let referenceFaceDescriptor = null;
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';

        auth.onAuthStateChanged(user => {
            if (user) { currentUser = user; initializeExam(); } 
            else { window.location.href = 'student_portal.html'; }
        });

        async function initializeExam() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                examId = urlParams.get('examId'); instId = urlParams.get('instId');
                if (!examId || !instId) throw new Error("Invalid exam link.");
                
                sessionRef = database.ref(`institutions/${instId}/sessions/${examId}/${currentUser.uid}`);
                
                const [examSnapshot, sessionSnapshot, studentSnapshot] = await Promise.all([
                    database.ref(`institutions/${instId}/exams/${examId}`).once('value'),
                    sessionRef.once('value'),
                    database.ref(`students/${currentUser.uid}`).once('value'),
                    Promise.all([ // Load face-api models
                        faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                    ])
                ]);

                if (!examSnapshot.exists()) throw new Error("Exam not found.");
                if (!studentSnapshot.exists()) throw new Error("Student profile not found.");

                examData = examSnapshot.val();
                studentProfile = studentSnapshot.val();
                
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('pre-exam-video').srcObject = stream;
                
                await prepareReferenceFaceDescriptor();

                if (sessionSnapshot.exists()) {
                    sessionState = sessionSnapshot.val();
                    resumeSession();
                } else {
                    await initializeNewSession();
                    switchView('pre-exam-view');
                    runPreExamChecks();
                }
            } catch (err) { showError(err.message); }
        }
        
        async function prepareReferenceFaceDescriptor() {
            return new Promise((resolve, reject) => {
                const referenceImage = new Image();
                referenceImage.crossOrigin = "Anonymous"; // Handle CORS for images from Firebase Storage
                referenceImage.onload = async () => {
                    const detection = await faceapi.detectSingleFace(referenceImage).withFaceLandmarks().withFaceDescriptor();
                    if (detection) {
                        referenceFaceDescriptor = detection.descriptor;
                        resolve();
                    } else {
                        reject(new Error("Could not detect a face in your profile photo. Please re-upload a clear photo."));
                    }
                };
                referenceImage.onerror = () => reject(new Error("Could not load your profile photo."));
                referenceImage.src = studentProfile.profilePhotoUrl;
            });
        }
        
        async function runPreExamChecks() {
            const statusEl = document.getElementById('face-match-status');
            const startBtn = document.getElementById('start-exam-btn');
            statusEl.textContent = "Verifying Identity... Please look at the camera.";
            
            const interval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(document.getElementById('pre-exam-video')).withFaceLandmarks().withFaceDescriptors();
                if (detections.length === 1 && referenceFaceDescriptor) {
                    const faceMatcher = new faceapi.FaceMatcher(referenceFaceDescriptor);
                    const bestMatch = faceMatcher.findBestMatch(detections[0].descriptor);
                    if (bestMatch.label === 'person 1' && bestMatch.distance < 0.5) {
                        statusEl.textContent = "✅ Identity Verified!";
                        statusEl.style.color = "green";
                        startBtn.disabled = false;
                        clearInterval(interval);
                    } else {
                        statusEl.textContent = "❌ Identity Mismatch. Please ensure you are the correct student.";
                        statusEl.style.color = "red";
                    }
                } else if (detections.length > 1) {
                    statusEl.textContent = "❌ Multiple people detected!";
                    statusEl.style.color = "red";
                }
            }, 2000);
        }

        document.getElementById('start-exam-btn').addEventListener('click', startExam);

        async function initializeNewSession() {
            sessionState = { phase: 'MCQ_PHASE', integrityScore: 100, timeLeft: examData.duration * 60, answers: {}, flags: [] };
            await sessionRef.set(sessionState);
        }

        function resumeSession() { /* Logic to resume from a specific phase */ }
        
        function startExam() {
            document.getElementById('header-info').style.display = 'block';
            document.getElementById('exam-title-header').textContent = examData.title;
            startMainTimer();
            startBrowserMonitoring();
            // Start periodic face check
            // ...
            renderPhaseUI();
        }

        function renderPhaseUI() {
            switch(sessionState.phase) {
                case 'MCQ_PHASE':
                    const mcqs = examData.questions.filter(q => q.type === 'MCQ');
                    if (mcqs.length > 0) {
                        renderExamView('MCQ Section (Multiple Choice)', mcqs, handleMcqSubmit);
                    } else {
                        // No MCQs, skip to CQ phase
                        sessionState.phase = 'CQ_PHASE';
                        sessionRef.update({ phase: 'CQ_PHASE' });
                        renderPhaseUI();
                    }
                    break;
                case 'CQ_PHASE':
                    const cqs = examData.questions.filter(q => q.type === 'CQ');
                    if (cqs.length > 0) {
                        renderExamView('CQ Section (Written Answers)', cqs, initiateUploadPhase);
                    } else {
                        // No CQs either, go straight to submission
                        submitFinalExam();
                    }
                    break;
                 // other phases...
            }
        }
        
        function renderExamView(title, questions, onSubmit) {
            const container = document.getElementById('exam-phase-view');
            // ... Renders the exam layout, proctoring sidebar, questions, and a submit button ...
            // The submit button's onclick will be the `onSubmit` function passed in.
            switchView('exam-phase-view');
        }

        function handleMcqSubmit() {
            // Grade MCQs
            let score = 0;
            const mcqs = examData.questions.filter(q => q.type === 'MCQ');
            mcqs.forEach((q, index) => {
                if (sessionState.answers[index] == q.correct) {
                    score++;
                }
            });
            sessionState.mcqScore = score;
            sessionRef.update({ mcqScore: score, phase: 'CQ_PHASE' });
            
            document.getElementById('mcq-score-display').textContent = `Your score for this section is ${score} out of ${mcqs.length}.`;
            switchView('mcq-result-view');
        }

        document.getElementById('proceed-to-cq-btn').addEventListener('click', renderPhaseUI);

        function startBrowserMonitoring() {
            document.addEventListener('visibilitychange', handleVisibilityChange);
            // ... copy/paste listeners ...
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                const overlay = document.getElementById('focus-lost-overlay');
                overlay.style.display = 'flex';
                let timeLeft = 15;
                const timerEl = document.getElementById('focus-timer');
                timerEl.textContent = timeLeft;
                focusLossInterval = setInterval(() => {
                    timeLeft--;
                    timerEl.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(focusLossInterval);
                        submitFinalExam();
                    }
                }, 1000);
            } else {
                clearInterval(focusLossInterval);
                document.getElementById('focus-lost-overlay').style.display = 'none';
            }
        }

        function submitFinalExam() {
            // ... stops timers, sets phase to SUBMITTED, shows final view ...
        }

        function switchView(viewName) { /* ... */ }
        function showError(message) { /* ... */ }
        function startMainTimer() { /* ... */ }
        function initiateUploadPhase() { /* ... */ }
        // ... all other helper functions ...
    </script>
</body>
</html>
