<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Exam Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- The main CSS is unchanged, but a new style for the loader is added -->
    <style>
        :root { --bg-color: #F8F9FA; --primary-text-color: #121212; --accent-color: #3D52F3; --accent-color-dark: #2335D8; --border-color: rgba(0, 0, 0, 0.1); --shadow-color: rgba(0, 0, 0, 0.04); --success-color: #28a745; --danger-color: #dc3545; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-color); color: var(--primary-text-color); margin: 0; }
        body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; background: linear-gradient(320deg, #E4DFFF 0%, #F5FAFF 50%, #DDEEFF 100%); animation: gradient-animation 20s ease-in-out infinite; background-size: 200% 200%; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .container { max-width: 1200px; margin: auto; padding: 0 1.5rem; }
        .main-header { position: sticky; top: 0; z-index: 1000; background-color: rgba(248, 249, 250, 0.7); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color); }
        .main-header .container { display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .logo { font-size: 1.5rem; font-weight: 800; text-decoration: none; color: var(--primary-text-color); }
        .page-wrapper { padding: 80px 0; }
        .content-card { background: #fff; border-radius: 12px; padding: clamp(1.5rem, 5vw, 3rem); box-shadow: 0 10px 40px var(--shadow-color); }
        h2 { font-size: clamp(2rem, 5vw, 2.8rem); text-align: center; margin-bottom: 1rem; }
        .content-card > p { max-width: 600px; margin: 0 auto 3rem; text-align: center; color: #595959; }
        .view { display: none; } .view.active { display: block; }

        /* --- NEW DYNAMIC LOADER STYLES --- */
        .loader-steps { list-style: none; padding: 0; max-width: 400px; margin: 2rem auto; }
        .loader-step { display: flex; align-items: center; font-size: 1.2em; font-weight: 500; margin-bottom: 1rem; color: var(--secondary-text-color); transition: color 0.3s; }
        .loader-step .status { margin-right: 1rem; font-size: 1.5em; width: 30px; text-align: center; }
        .loader-step.completed { color: var(--primary-text-color); }
        /* (Other styles for exam, upload, etc. are unchanged) */
        .exam-layout { display: grid; grid-template-columns: 1fr 320px; gap: 2.5rem; }
        .proctoring-sidebar { background: linear-gradient(180deg, #F8F9FA, #FFFFFF); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); }
        #video { width: 100%; border-radius: 8px; transform: scaleX(-1); }
        .cta-button { display: inline-block; background-color: var(--accent-color); color: #FFF; padding: 1rem 2.5rem; border-radius: 8px; font-weight: 500; border: none; cursor: pointer; transition: all .3s ease; }
    </style>
</head>
<body>
    <header class="main-header"><div class="container"><a href="#" class="logo">SecureExam+</a><div id="header-info" class="header-info" style="display: none;"><h3 id="exam-title-header"></h3><p id="exam-timer">Time Left: --:--</p></div></div></header>
    
    <main class="page-wrapper"><div class="container"><div class="content-card">
        <div id="initial-loader" class="view active">
            <h2>Preparing Your Secure Session...</h2>
            <ul class="loader-steps">
                <li id="step-connect" class="loader-step"><span class="status">⏳</span>Connecting to Server...</li>
                <li id="step-fetch" class="loader-step"><span class="status">⚪</span>Fetching Exam Data...</li>
                <li id="step-ai" class="loader-step"><span class="status">⚪</span>Initializing AI Proctoring...</li>
                <li id="step-camera" class="loader-step"><span class="status">⚪</span>Awaiting Camera Permission...</li>
            </ul>
        </div>

        <div id="error-view" class="view" style="text-align: center; color: var(--danger-color);"><h2>An Error Occurred</h2><p id="error-message"></p></div>
        
        <!-- Other views (exam, upload, submission) are unchanged structurally -->
        <div id="exam-view" class="view">...</div>
        <div id="upload-view" class="view">...</div>
        <div id="submission-view" class="view">...</div>
    </div></div></main>
    
    <footer class="footer" style="text-align:center; padding: 2rem 0; color: #595959;"><p>© 2025 SecureExam+. All Rights Reserved.</p></footer>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-storage-compat.js"></script>
    <!-- AI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        // --- YOUR FIREBASE CONFIGURATION ---
        const firebaseConfig = { apiKey: "AIzaSyAPgoVPBdYnnMHRnKbGJIe87HJ_Py82XUQ", authDomain: "mathemate-software.firebaseapp.com", databaseURL: "https://mathemate-software-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "mathemate-software", storageBucket: "mathemate-software.appspot.com", messagingSenderId: "780184955321", appId: "YOUR_WEB_APP_ID" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        
        // --- State, Timers, and Firebase Refs ---
        let examData, sessionState, examId, userId, sessionRef, stream;
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';

        // --- DOM Elements ---
        const views = { loader: document.getElementById('initial-loader'), error: document.getElementById('error-view'), exam: document.getElementById('exam-view'), upload: document.getElementById('upload-view'), submission: document.getElementById('submission-view') };
        const loaderSteps = { connect: document.getElementById('step-connect'), fetch: document.getElementById('step-fetch'), ai: document.getElementById('step-ai'), camera: document.getElementById('step-camera') };
        const video = document.getElementById('video');

        // --- NEW: Dynamic Loader UI Update Function ---
        function updateLoaderStep(step, status, message) {
            const stepEl = loaderSteps[step];
            if (!stepEl) return;
            const statusIcon = stepEl.querySelector('.status');
            const textEl = stepEl.lastChild;

            switch (status) {
                case 'loading': statusIcon.textContent = '⏳'; break;
                case 'success': statusIcon.textContent = '✅'; stepEl.classList.add('completed'); break;
                case 'failed': statusIcon.textContent = '❌'; stepEl.classList.add('completed'); break;
                default: statusIcon.textContent = '⚪';
            }
            if (message) textEl.textContent = message;
        }

        // --- NEW: Parallel AI Model Loading Function ---
        async function loadAiModels() {
            updateLoaderStep('ai', 'loading', 'Initializing AI Proctoring...');
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                cocoSsd.load() // coco-ssd loads its own models
            ]);
            updateLoaderStep('ai', 'success', 'AI Proctoring Ready');
        }
        
        // --- NEW: Parallel Camera Request Function ---
        async function requestCamera() {
            updateLoaderStep('camera', 'loading', 'Awaiting Camera Permission...');
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                video.srcObject = stream;
                updateLoaderStep('camera', 'success', 'Camera & Mic Access Granted');
                return stream;
            } catch (err) {
                updateLoaderStep('camera', 'failed', 'Camera & Mic Access Denied');
                throw new Error("Permission for Camera and Microphone was denied. This exam requires proctoring.");
            }
        }
        
        // --- RE-ARCHITECTED: Main Initialization Logic ---
        window.onload = async () => {
            log('Page loaded. Starting parallel initialization.');
            const urlParams = new URLSearchParams(window.location.search);
            examId = urlParams.get('id');

            if (!examId) return showError("No Exam ID found in URL.");
            
            userId = sessionStorage.getItem('userId') || 'user_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('userId', userId);
            sessionRef = database.ref(`sessions/${examId}/${userId}`);
            updateLoaderStep('connect', 'success', 'Connected to Server');

            // --- The Magic: Run everything at once! ---
            try {
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Initialization timed out.")), 15000)); // 15-second timeout

                const [examSnapshot, sessionSnapshot] = await Promise.race([
                    Promise.all([
                        database.ref(`exams/${examId}`).once('value'), // Task 1
                        sessionRef.once('value'),                    // Task 2
                        loadAiModels(),                              // Task 3
                        requestCamera()                              // Task 4
                    ]),
                    timeoutPromise
                ]);

                updateLoaderStep('fetch', 'success', 'Exam Data Fetched');
                
                if (!examSnapshot.exists()) return showError("Invalid Exam ID.");
                examData = examSnapshot.val();

                if (sessionSnapshot.exists()) {
                    log('Resuming existing session...');
                    await resumeSession(sessionSnapshot.val());
                } else {
                    log('Creating new session...');
                    await initializeNewSession();
                }

            } catch (err) {
                console.error("Initialization Error:", err);
                showError(err.message);
            }
        };

        async function initializeNewSession() {
            sessionState = {
                phase: 'IN_PROGRESS',
                integrityScore: 100,
                timeLeft: examData.duration * 60,
                uploadTimeLeft: UPLOAD_GRACE_PERIOD,
                answers: {},
                flags: [],
                startTime: firebase.database.ServerValue.TIMESTAMP
            };
            await sessionRef.set(sessionState);
            log('New session created in Firebase.');
            startExam();
        }

        async function resumeSession(state) {
            sessionState = state;
            log(`Resuming at phase: ${sessionState.phase}`);
            if (sessionState.phase === 'IN_PROGRESS') startExam();
            else if (sessionState.phase === 'UPLOADING') initiateUploadPhase(true);
            else if (sessionState.phase === 'SUBMITTED') switchView('submission');
        }

        function startExam() {
            switchView('exam');
            renderExam();
            startMainTimer();
            // Proctoring functions will be called from here...
            log("Exam Started. Monitoring is active.");
        }

        // --- All other functions (renderExam, timers, upload, submission, UI helpers) are largely unchanged ---
        function renderExam() { /* Unchanged from previous version */ }
        function startMainTimer() { /* Unchanged from previous version */ }
        function initiateUploadPhase(isResume = false) { /* Unchanged */ }
        function startUploadTimer() { /* Unchanged */ }
        document.getElementById('answer-sheet-input').addEventListener('change', (e) => { /* Unchanged */ });
        document.getElementById('submit-answersheet-btn').addEventListener('click', submitFinalExam);
        function submitFinalExam() { /* Unchanged */ }
        function showError(message) { switchView('error'); document.getElementById('error-message').textContent = message; }
        function log(message) { console.log(`[${new Date().toLocaleTimeString()}] ${message}`); }
        function switchView(viewName) { Object.values(views).forEach(v => v.classList.remove('active')); views[viewName].classList.add('active'); }
        // The HTML for other views needs to be present in the document.
        document.getElementById('exam-view').innerHTML = `<div class="exam-layout"><div class="exam-content"><div class="exam-paper" id="exam-paper-content"></div><div class="button-group" style="text-align: center; margin-top: 2rem;"><button id="finish-writing-btn" class="cta-button">Finish Writing & Proceed to Upload</button></div></div><div class="proctoring-sidebar"><h3>Live Monitoring</h3><div id="video-container"><video id="video" autoplay muted playsinline></video></div><ul class="monitoring-status" style="list-style: none; padding: 0;"><li><span id="status-face" class="status-indicator"></span>Face Presence</li><li><span id="status-objects" class="status-indicator"></span>Prohibited Objects</li><li><span id="status-audio" class="status-indicator"></span>Unusual Noise</li><li><span id="status-browser" class="status-indicator"></span>Browser Focus</li></ul><div id="integrity-score-display" style="text-align: center; margin-top: 2rem;"><p>Integrity Score</p><span id="integrity-score">100</span></div></div></div>`;
        document.getElementById('upload-view').innerHTML = `<h2>Answer Sheet Submission</h2><p>Time is up. You now have a <strong id="upload-grace-period">5 minute</strong> grace period to capture and upload a clear picture of your answer sheet. Proctoring is paused.</p><div id="upload-area"><input type="file" id="answer-sheet-input" accept="image/*" style="display: none;"><label for="answer-sheet-input" id="upload-label" class="cta-button">Click to Select Answer Sheet Image</label><img id="image-preview" src="" alt="Image Preview" style="display: none;"></div><div class="button-group" style="text-align: center; margin-top: 2rem;"><button id="submit-answersheet-btn" class="cta-button" disabled>Submit Final Answer Sheet</button></div>`;
        document.getElementById('submission-view').innerHTML = `<h2 style="text-align: center;">Exam Submitted Successfully</h2><p>Your responses and answer sheet have been recorded. You may now close this window.</p><p style="text-align:center; font-size: 4em; margin-top: 2rem;">✅</p>`;
    </script>
</body>
</html>
