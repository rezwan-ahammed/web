<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - Secure Exam Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #F8F9FA; --primary-text-color: #121212; --accent-color: #3D52F3; --border-color: rgba(0, 0, 0, 0.1); --shadow-color: rgba(0, 0, 0, 0.04); --success-color: #28a745; --danger-color: #dc3545; --warning-color: #ffc107; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-color); color: var(--primary-text-color); margin: 0; }
        .container { max-width: 1200px; margin: auto; padding: 2rem; }
        .header { text-align: center; margin-bottom: 2rem; }
        .view { display: none; } .view.active { display: block; }
        .card { background: #fff; border-radius: 12px; padding: 2rem; box-shadow: 0 5px 25px var(--shadow-color); margin-bottom: 1rem; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; cursor: pointer; transition: transform .2s, box-shadow .2s; }
        .list-item:hover { transform: translateY(-3px); box-shadow: 0 8px 25px var(--shadow-color); }
        .list-item h3 { margin: 0; }
        .score { font-weight: 700; font-size: 1.2em; padding: 0.5rem 1rem; border-radius: 8px; color: #fff; }
        .score.high { background-color: var(--success-color); }
        .score.medium { background-color: var(--warning-color); }
        .score.low { background-color: var(--danger-color); }
        .back-btn { display: inline-block; margin-bottom: 2rem; color: var(--accent-color); font-weight: 700; text-decoration: none; cursor: pointer; }
        .review-layout { display: grid; grid-template-columns: 1fr 350px; gap: 2rem; }
        .review-answers .question-block { margin-bottom: 2rem; }
        .mcq-option { list-style: none; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid var(--border-color); }
        .mcq-option.correct { background-color: #eaf7ec; border-color: var(--success-color); }
        .mcq-option.incorrect { background-color: #fdeaea; border-color: var(--danger-color); }
        .mcq-option.selected::before { content: 'â–¶ '; font-weight: bold; color: var(--accent-color); }
        .review-sidebar #answer-sheet-img { width: 100%; border-radius: 8px; border: 1px solid var(--border-color); }
        .flags-list { list-style: none; padding: 0; }
        .flags-list li { background: #fff8e1; padding: 0.5rem; border-radius: 5px; margin-bottom: 0.5rem; font-size: 0.9em; }
        @media (max-width: 900px) { .review-layout { grid-template-columns: 1fr; } .review-sidebar { order: -1; } }
    </style>
</head>
<body>
    <div class="container">
        <!-- VIEW 1: EXAM LIST -->
        <div id="exam-list-view" class="view active">
            <div class="header"><h1>Teacher Dashboard</h1><p>Select an exam to review submissions.</p></div>
            <div id="exam-list-container">
                <p>Loading exams from database...</p>
            </div>
        </div>

        <!-- VIEW 2: STUDENT LIST -->
        <div id="student-list-view" class="view">
            <a class="back-btn" id="back-to-exams">&larr; Back to All Exams</a>
            <div class="header"><h1 id="student-list-title"></h1><p>Select a student to review their submission.</p></div>
            <div id="student-list-container"></div>
        </div>

        <!-- VIEW 3: DETAILED REVIEW -->
        <div id="review-view" class="view">
            <a class="back-btn" id="back-to-students">&larr; Back to Student List</a>
            <div class="review-layout">
                <div class="review-answers card">
                    <h2 id="review-exam-title"></h2>
                    <div id="review-content"></div>
                </div>
                <div class="review-sidebar card">
                    <h3>Submission Details</h3>
                    <p><strong>Student ID:</strong> <span id="review-student-id"></span></p>
                    <hr>
                    <h4>Integrity Score</h4>
                    <p style="text-align: center;"><span id="review-integrity-score" class="score"></span></p>
                    <hr>
                    <h4>Uploaded Answer Sheet</h4>
                    <img id="answer-sheet-img" src="https://via.placeholder.com/400x300/e0e0e0/333?text=No+Sheet+Uploaded" alt="Student Answer Sheet">
                    <hr>
                    <h4>Proctoring Flags</h4>
                    <ul id="review-flags" class="flags-list"><p>No flags recorded.</p></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>

    <script>
        // --- YOUR FIREBASE CONFIGURATION ---
        const firebaseConfig = { apiKey: "AIzaSyAPgoVPBdYnnMHRnKbGJIe87HJ_Py82XUQ", authDomain: "mathemate-software.firebaseapp.com", databaseURL: "https://mathemate-software-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "mathemate-software", storageBucket: "mathemate-software.appspot.com", messagingSenderId: "780184955321", appId: "YOUR_WEB_APP_ID" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- State ---
        let currentExamId = null;

        // --- DOM Elements ---
        const views = {
            exams: document.getElementById('exam-list-view'),
            students: document.getElementById('student-list-view'),
            review: document.getElementById('review-view')
        };
        const containers = {
            exams: document.getElementById('exam-list-container'),
            students: document.getElementById('student-list-container'),
            reviewContent: document.getElementById('review-content'),
        };

        // --- Navigation ---
        document.getElementById('back-to-exams').addEventListener('click', loadExams);
        document.getElementById('back-to-students').addEventListener('click', () => loadStudentsForExam(currentExamId));

        function switchView(viewName) {
            Object.values(views).forEach(v => v.classList.remove('active'));
            views[viewName].classList.add('active');
        }

        // --- Data Loading and Rendering ---

        async function loadExams() {
            switchView('exams');
            containers.exams.innerHTML = '<p>Loading exams...</p>';
            try {
                const snapshot = await database.ref('exams').once('value');
                if (!snapshot.exists()) {
                    containers.exams.innerHTML = '<p>No exams have been created yet.</p>';
                    return;
                }
                containers.exams.innerHTML = '';
                snapshot.forEach(examSnapshot => {
                    const examId = examSnapshot.key;
                    const exam = examSnapshot.val();
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `<h3>${exam.title}</h3><span>${exam.questions.length} Questions</span>`;
                    item.addEventListener('click', () => loadStudentsForExam(examId));
                    containers.exams.appendChild(item);
                });
            } catch (error) {
                console.error("Error loading exams:", error);
                containers.exams.innerHTML = `<p style="color:red;">Error: Could not load exams. ${error.message}</p>`;
            }
        }

        async function loadStudentsForExam(examId) {
            currentExamId = examId; // Store for back navigation
            switchView('students');
            containers.students.innerHTML = '<p>Loading submissions...</p>';
            try {
                const examTitle = (await database.ref(`exams/${examId}/title`).once('value')).val();
                document.getElementById('student-list-title').textContent = `Submissions for "${examTitle}"`;

                const sessionsSnapshot = await database.ref(`sessions/${examId}`).once('value');
                if (!sessionsSnapshot.exists()) {
                    containers.students.innerHTML = '<p>No students have submitted this exam yet.</p>';
                    return;
                }
                containers.students.innerHTML = '';
                sessionsSnapshot.forEach(sessionSnapshot => {
                    const userId = sessionSnapshot.key;
                    const session = sessionSnapshot.val();
                    const score = session.integrityScore || 100;

                    const item = document.createElement('div');
                    item.className = 'list-item';
                    let scoreClass = 'high';
                    if (score < 90 && score >= 75) scoreClass = 'medium';
                    if (score < 75) scoreClass = 'low';

                    item.innerHTML = `<h3>Student ID: ${userId}</h3><span class="score ${scoreClass}">${score}</span>`;
                    item.addEventListener('click', () => loadDetailedReview(examId, userId));
                    containers.students.appendChild(item);
                });
            } catch (error) {
                console.error("Error loading students:", error);
                containers.students.innerHTML = `<p style="color:red;">Error: Could not load submissions. ${error.message}</p>`;
            }
        }

        async function loadDetailedReview(examId, userId) {
            switchView('review');
            containers.reviewContent.innerHTML = '<p>Loading submission details...</p>';
            try {
                const [examSnapshot, sessionSnapshot] = await Promise.all([
                    database.ref(`exams/${examId}`).once('value'),
                    database.ref(`sessions/${examId}/${userId}`).once('value')
                ]);
                const exam = examSnapshot.val();
                const session = sessionSnapshot.val();
                
                // --- Render Sidebar ---
                document.getElementById('review-exam-title').textContent = exam.title;
                document.getElementById('review-student-id').textContent = userId;
                const scoreEl = document.getElementById('review-integrity-score');
                const score = session.integrityScore || 100;
                scoreEl.textContent = score;
                scoreEl.className = 'score';
                if (score >= 90) scoreEl.classList.add('high');
                else if (score >= 75) scoreEl.classList.add('medium');
                else scoreEl.classList.add('low');
                
                document.getElementById('answer-sheet-img').src = session.answerSheetUrl || 'https://via.placeholder.com/400x300/e0e0e0/333?text=No+Sheet+Uploaded';
                
                const flagsContainer = document.getElementById('review-flags');
                if (session.flags && session.flags.length > 0) {
                    flagsContainer.innerHTML = '';
                    session.flags.forEach(flag => {
                        const flagItem = document.createElement('li');
                        flagItem.textContent = `[${new Date(flag.timestamp).toLocaleTimeString()}] ${flag.description}`;
                        flagsContainer.appendChild(flagItem);
                    });
                } else {
                    flagsContainer.innerHTML = '<p>No flags recorded.</p>';
                }

                // --- Render Main Content (Answers) ---
                containers.reviewContent.innerHTML = '';
                exam.questions.forEach((q, index) => {
                    const qBlock = document.createElement('div');
                    qBlock.className = 'question-block';
                    let content = `<h4>Question ${index + 1}: ${q.text}</h4>`;
                    
                    if (q.type === 'MCQ') {
                        const studentAnswerIndex = session.answers ? session.answers[index] : -1;
                        const correctAnswerIndex = q.correct;
                        content += `<ul style="padding: 0;">`;
                        q.options.forEach((option, i) => {
                            let classes = 'mcq-option';
                            if (i == correctAnswerIndex) classes += ' correct';
                            if (i == studentAnswerIndex && studentAnswerIndex != correctAnswerIndex) classes += ' incorrect';
                            if (i == studentAnswerIndex) classes += ' selected';
                            content += `<li class="${classes}">${option}</li>`;
                        });
                        content += `</ul>`;
                    } else { // CQ
                        content += `<p><i>(Refer to the uploaded answer sheet for the student's response.)</i></p>`;
                    }
                    qBlock.innerHTML = content;
                    containers.reviewContent.appendChild(qBlock);
                });

            } catch (error) {
                console.error("Error loading review:", error);
                containers.reviewContent.innerHTML = `<p style="color:red;">Error: Could not load submission details. ${error.message}</p>`;
            }
        }

        // --- Initial Load ---
        window.onload = loadExams;
    </script>
</body>
</html>
