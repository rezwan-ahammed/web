<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - SecureExam+</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        /* CSS from previous version is largely unchanged */
        :root { --accent-color: #3D52F3; --border-color: rgba(0, 0, 0, 0.1); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(320deg, #E4DFFF 0%, #F5FAFF 100%); margin: 0; }
        .portal-container { background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); width: 100%; max-width: 500px; }
        h1 { font-size: 2.2rem; text-align: center; margin-bottom: 0.5rem; }
        p { text-align: center; color: #595959; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 700; margin-bottom: 0.5rem; }
        input, select { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        .btn { display: block; width: 100%; background-color: var(--accent-color); color: #FFF; padding: 0.9rem; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; font-size: 1.1rem; }
        /* Other styles unchanged */
    </style>
</head>
<body>
    <div class="portal-container">
        <!-- Login View is unchanged -->
        <div id="login-view" class="view active">...</div>

        <!-- Register View -->
        <div id="register-view" class="view">
            <h1>Student Registration</h1><p>Step 1: Create your account.</p>
            <form id="register-form"><!-- Email/Password fields unchanged --></form>
        </div>
        
        <!-- UPDATED Profile & Photo Setup -->
        <div id="profile-setup-view" class="view">
            <h1>Complete Your Profile</h1><p>Step 2 & 3: Information and Photo</p>
            <form id="profile-form">
                <div class="form-group"><label for="profile-name">Full Name</label><input type="text" id="profile-name" required></div>
                <div class="form-group"><label for="profile-studentid">Student ID Number</label><input type="text" id="profile-studentid" required></div>
                <div class="form-group"><label for="profile-phone">Phone Number</label><input type="tel" id="profile-phone" required></div>
                
                <div class="form-group">
                    <label for="profile-institution">Your Institution</label>
                    <input type="text" id="institution-search" placeholder="Search for your institution...">
                    <select id="profile-institution" required size="5" style="margin-top: 0.5rem;"></select>
                </div>

                <div class="form-group">
                    <label for="profile-class">Your Class</label>
                    <select id="profile-class" required>
                        <option value="" disabled selected>Select your class</option>
                        <option value="9">Class 9</option>
                        <option value="10">Class 10</option>
                        <option value="11">Class 11 (HSC 1st Year)</option>
                        <option value="12">Class 12 (HSC 2nd Year)</option>
                        <option value="admission">University Admission</option>
                    </select>
                </div>

                <!-- Camera and photo capture elements are unchanged -->
                <p style="font-weight:700;">Profile Photo</p>
                <!-- ... video, img, canvas elements ... -->
                <button type="button" class="btn" id="capture-photo-btn">Capture Photo</button>
                <br>
                <button type="submit" class="btn" id="complete-profile-btn" disabled>Complete Registration</button>
            </form>
        </div>
        <p id="error-message"></p>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <!-- ... all other SDKs ... -->
    <script>
        // Firebase config is unchanged
        
        // ... Auth Guard and view toggling logic are unchanged ...

        // NEW: Load institutions into the dropdown on page load
        window.onload = () => {
            const institutionSelect = document.getElementById('profile-institution');
            database.ref('institutions').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const instId = childSnapshot.key;
                        const instData = childSnapshot.val();
                        const option = document.createElement('option');
                        option.value = instId;
                        option.textContent = instData.name;
                        institutionSelect.appendChild(option);
                    });
                }
            });
        };
        
        // NEW: Search/filter logic for institutions
        document.getElementById('institution-search').addEventListener('keyup', e => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#profile-institution option').forEach(option => {
                const institutionName = option.textContent.toLowerCase();
                option.style.display = institutionName.includes(searchTerm) ? '' : 'none';
            });
        });

        // UPDATED: Profile submission logic
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            // ... (photo capture validation is the same) ...
            
            try {
                // ... (photo upload logic is the same) ...
                const photoUrl = await uploadTask.ref.getDownloadURL();

                // Collect ALL new data points
                const studentData = {
                    fullName: document.getElementById('profile-name').value,
                    studentId: document.getElementById('profile-studentid').value,
                    phone: document.getElementById('profile-phone').value,
                    institutionId: document.getElementById('profile-institution').value,
                    class: document.getElementById('profile-class').value,
                    email: currentUser.email,
                    profilePhotoUrl: photoUrl
                };

                if(!studentData.institutionId) {
                    throw new Error("Please select your institution from the list.");
                }

                await database.ref(`students/${currentUser.uid}`).set(studentData);
                window.location.href = 'student_dashboard.html';

            } catch (error) {
                // ... (error handling is the same) ...
            }
        });
        
        // ... Other functions (login, registration) are unchanged ...
    </script>
</body>
</html>
