<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - SecureExam+</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent-color: #3D52F3; --accent-color-dark: #2335D8; --border-color: rgba(0, 0, 0, 0.1); --shadow-color: rgba(0, 0, 0, 0.05); --danger-color: #dc3545; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(320deg, #E4DFFF 0%, #F5FAFF 100%); margin: 0; }
        .portal-container { background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 40px var(--shadow-color); width: 100%; max-width: 500px; }
        h1 { font-size: 2.2rem; text-align: center; margin-bottom: 0.5rem; color: #121212; }
        p { text-align: center; color: #595959; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 700; margin-bottom: 0.5rem; color: #121212; }
        input, select { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        .btn { display: block; width: 100%; background-color: var(--accent-color); color: #FFF; padding: 0.9rem; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; font-size: 1.1rem; transition: all .3s ease; }
        .btn:hover:not(:disabled) { background-color: var(--accent-color-dark); transform: translateY(-3px); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .toggle-link { text-align: center; margin-top: 1.5rem; }
        .toggle-link a { color: var(--accent-color); font-weight: 700; cursor: pointer; }
        #error-message { color: var(--danger-color); text-align: center; margin-top: 1rem; font-weight: 500; min-height: 1.2em; }
        .view { display: none; } .view.active { display: block; }
        #camera-feed, #photo-preview { width: 100%; max-width: 300px; margin: 1rem auto; display: block; border-radius: 8px; border: 1px solid var(--border-color); transform: scaleX(-1); }
        #no-institutions-found { color: var(--danger-color); font-weight: 500; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <div class="portal-container">
        <!-- Login & Register Views are unchanged -->
        <div id="login-view" class="view active">...</div>
        <div id="register-view" class="view">...</div>

        <!-- FIXED Profile & Photo Setup View -->
        <div id="profile-setup-view" class="view">
            <h1>Complete Your Profile</h1><p>Step 2 & 3: Information and Photo</p>
            <form id="profile-form">
                <div class="form-group"><label for="profile-name">Full Name</label><input type="text" id="profile-name" required></div>
                <div class="form-group"><label for="profile-studentid">Student ID Number</label><input type="text" id="profile-studentid" required></div>
                <div class="form-group"><label for="profile-phone">Phone Number</label><input type="tel" id="profile-phone" required></div>
                <div class="form-group">
                    <label for="profile-institution">Your Institution</label>
                    <input type="text" id="institution-search" placeholder="Search for your institution...">
                    <select id="profile-institution" required size="4" style="margin-top: 0.5rem;"></select>
                    <p id="no-institutions-found" style="display: none;">No institutions found.</p>
                </div>
                <div class="form-group">
                    <label for="profile-class">Your Class</label>
                    <select id="profile-class" required>
                        <option value="" disabled selected>Select your class</option>
                        <option value="9">Class 9</option><option value="10">Class 10</option>
                        <option value="11">Class 11 (HSC 1st Year)</option><option value="12">Class 12 (HSC 2nd Year)</option>
                        <option value="admission">University Admission</option>
                    </select>
                </div>
                <p style="font-weight:700; margin-bottom: 1rem;">Profile Photo</p>
                <video id="camera-feed" autoplay playsinline style="display: none;"></video>
                <img id="photo-preview" style="display:none;"><canvas id="photo-canvas" style="display:none;"></canvas>
                <button type="button" class="btn" id="capture-photo-btn" style="background-color: #6c757d; margin-bottom: 1rem;">Capture Photo</button>
                <button type="submit" class="btn" id="complete-profile-btn" disabled>Complete Registration</button>
            </form>
        </div>
        <p id="error-message"></p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-storage-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAPgoVPBdYnnMHRnKbGJIe87HJ_Py82XUQ", authDomain: "mathemate-software.firebaseapp.com", databaseURL: "https://mathemate-software-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "mathemate-software", storageBucket: "mathemate-software.appspot.com", messagingSenderId: "780184955321", appId: "YOUR_WEB_APP_ID" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        const views = { login: document.getElementById('login-view'), register: document.getElementById('register-view'), profile: document.getElementById('profile-setup-view') };
        const videoEl = document.getElementById('camera-feed');
        const previewEl = document.getElementById('photo-preview');
        const captureBtn = document.getElementById('capture-photo-btn');
        let capturedPhotoBlob = null;
        let currentUser = null;

        // --- Role-Based Auth Guard and View Toggling are unchanged ---
        // ...

        // --- DYNAMICALLY LOAD INSTITUTIONS ---
        window.onload = () => {
            const institutionSelect = document.getElementById('profile-institution');
            database.ref('institutions').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const option = document.createElement('option');
                        option.value = childSnapshot.key;
                        option.textContent = childSnapshot.val().name;
                        institutionSelect.appendChild(option);
                    });
                }
            });
        };

        // --- FIXED - INSTITUTION SEARCH ---
        document.getElementById('institution-search').addEventListener('keyup', e => {
            const searchTerm = e.target.value.toLowerCase();
            let visibleCount = 0;
            document.querySelectorAll('#profile-institution option').forEach(option => {
                const institutionName = option.textContent.toLowerCase();
                const isVisible = institutionName.includes(searchTerm);
                option.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });
            document.getElementById('no-institutions-found').style.display = visibleCount > 0 ? 'none' : 'block';
        });
        
        // --- STEP 1: Registration (Unchanged) ---
        // ...
        
        // --- FIXED - STEP 2 & 3: PROFILE AND PHOTO ---
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoEl.srcObject = stream;
                videoEl.style.display = 'block';
                previewEl.style.display = 'none';
                captureBtn.textContent = 'Capture Photo';
            } catch (err) { errorMessage.textContent = "Camera access is required to create a profile."; }
        }

        captureBtn.addEventListener('click', () => {
            if (videoEl.style.display === 'block') { // If camera is live, capture
                const canvas = document.getElementById('photo-canvas');
                canvas.width = videoEl.videoWidth;
                canvas.height = videoEl.videoHeight;
                const context = canvas.getContext('2d');
                context.scale(-1, 1);
                context.drawImage(videoEl, -canvas.width, 0);

                previewEl.src = canvas.toDataURL('image/jpeg');
                previewEl.style.display = 'block';
                videoEl.style.display = 'none';

                canvas.toBlob(blob => { capturedPhotoBlob = blob; }, 'image/jpeg', 0.9);
                document.getElementById('complete-profile-btn').disabled = false;
                captureBtn.textContent = 'Recapture Photo';
            } else { // If preview is showing, restart camera
                startCamera();
                capturedPhotoBlob = null;
                document.getElementById('complete-profile-btn').disabled = true;
            }
        });
        
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            // ... The submission logic is unchanged from the previous fixed version ...
        });

        // --- Login Logic (Unchanged) ---
        // ...
    </script>
</body>
</html>
